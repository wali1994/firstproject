<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Blood Donation RecSys — Output Results</title>
<style>
  :root{
    --bg:#0b1220;            /* deep blue-bg */
    --card:#0f1a2b;
    --muted:#97b4c0;
    --green:#29a36a;         /* green theme */
    --blue:#2a6bd6;          /* blue theme */
    --accent:#3ad29b;
    --danger:#e45757;
    --ring:#1f3559;
    --text:#eaf2f6;
    --text-soft:#cfe0e8;
    --chip:#163252;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(180deg, #081223 0%, #0b1424 60%, #0a1626 100%);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(11,18,32,.8); backdrop-filter: blur(6px);
    border-bottom:1px solid var(--ring);
  }
  .wrap{max-width:1200px; margin:0 auto; padding:16px 20px;}
  .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px}
  .brand .logo{
    width:36px; height:36px; border-radius:10px;
    background:linear-gradient(145deg,var(--blue), var(--green));
    display:grid; place-items:center; font-weight:900;
    box-shadow:0 6px 20px rgba(45,148,227,.25), inset 0 0 20px rgba(58,210,155,.2);
  }
  .grid{
    display:grid; gap:16px; grid-template-columns:340px 1fr; margin-top:16px;
  }
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:16px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  h2{margin:.2rem 0 1rem; font-size:1.1rem; color:var(--text-soft); font-weight:700}
  .controls label{display:block; font-size:.85rem; color:var(--muted); margin:10px 0 6px}
  input[type="number"], input[type="text"], select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring);
    background:#0b1830; color:var(--text); outline:none;
  }
  input[type="range"]{width:100%}
  .btn{
    background:linear-gradient(135deg, var(--blue), var(--green)); color:white; border:none;
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    box-shadow:0 10px 24px rgba(42,107,214,.25);
  }
  .btn.secondary{background:#123258}
  .btn.ghost{background:transparent; border:1px solid var(--ring)}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
  .kpi{background:#0c1b30; border:1px solid var(--ring); border-radius:14px; padding:14px}
  .kpi .val{font-size:1.4rem; font-weight:800}
  .table-wrap{overflow:auto; border:1px solid var(--ring); border-radius:14px}
  table{width:100%; border-collapse:collapse; font-size:.95rem}
  th,td{padding:10px 12px; border-bottom:1px solid #122745; white-space:nowrap}
  th{position:sticky; top:0; background:#0d1e35; text-align:left; font-weight:700; cursor:pointer}
  tr:hover td{background:#0c1d33}
  .badge{padding:4px 8px; border-radius:999px; font-size:.75rem; font-weight:700}
  .hi{background:rgba(58,210,155,.15); color:#6cf0bb; border:1px solid rgba(58,210,155,.35)}
  .mid{background:rgba(42,107,214,.18); color:#8cc2ff; border:1px solid rgba(42,107,214,.35)}
  .low{background:rgba(228,87,87,.14); color:#ffb3b3; border:1px solid rgba(228,87,87,.35)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .chip{background:var(--chip); padding:6px 10px; border-radius:999px; border:1px solid var(--ring); color:#c8def0}
  .foot{margin-top:10px; color:var(--muted); font-size:.8rem}
  canvas{background:#081427; border-radius:12px; border:1px solid var(--ring)}
  .hint{font-size:.8rem; color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">SB</div>
        <div>
          Smart Blood Donation Recommendation System — <span style="color:#7fdcb6;font-weight:800">Output Results</span><br>
          <span class="hint">By: Bhuian Md Waliulla • Subject: Recommendation System • Group: BABDS 241</span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- LEFT: Controls -->
    <aside class="card">
      <h2>Data & Scoring</h2>
      <div class="controls">
        <label>Upload CSV
          <input id="fileInput" type="file" accept=".csv" />
        </label>
        <div class="hint">Accepted headers:<br>
          <b>Option A</b> (compute here): <code>Donor_ID,Recency,Frequency,Monetary,Time</code><br>
          <b>Option B</b> (use provided): add <code>Probability</code> column.</div>

        <hr style="border:none;border-top:1px solid var(--ring); margin:14px 0">

        <label>Scoring Mode</label>
        <select id="mode">
          <option value="compute">Option A — Compute probability in browser</option>
          <option value="use">Option B — Use Probability from CSV</option>
        </select>

        <div id="weights">
          <label>Weights (for Option A)</label>
          <div class="chip">Sigmoid( b + wR*(-Recency) + wF*Frequency + wM*(Monetary/1000) + wT*Time )</div>
          <label>Bias b: <input id="wB" type="number" step="0.1" value=" -1.0 "></label>
          <label>wR (Recency, negative): <input id="wR" type="number" step="0.05" value="-0.12"></label>
          <label>wF (Frequency): <input id="wF" type="number" step="0.05" value="0.10"></label>
          <label>wM (Monetary): <input id="wM" type="number" step="0.05" value="0.06"></label>
          <label>wT (Time): <input id="wT" type="number" step="0.05" value="0.02"></label>
          <div class="hint">Adjust to mirror your trained model’s behavior.</div>
        </div>

        <hr style="border:none;border-top:1px solid var(--ring); margin:14px 0">

        <label>Minimum Probability (filter)</label>
        <input id="minProb" type="range" min="0" max="1" step="0.01" value="0.5">
        <div class="hint"><b id="minProbVal">0.50</b> threshold for readiness.</div>

        <label>Show Top-N</label>
        <input id="topN" type="number" min="1" value="25">

        <div style="display:flex; gap:8px; margin-top:12px">
          <button class="btn" id="run">Process</button>
          <button class="btn ghost" id="sample">Load Sample</button>
        </div>

        <div class="foot">Tip: Use column header clicks to sort. Export your filtered top list below.</div>
      </div>
    </aside>

    <!-- RIGHT: Results -->
    <section class="card">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:12px">
        <div class="toolbar">
          <span class="chip">Min P: <b id="chipMin">0.50</b></span>
          <span class="chip">Top-N: <b id="chipTop">25</b></span>
          <span class="chip">Mode: <b id="chipMode">Compute</b></span>
        </div>
        <div class="toolbar">
          <input id="search" type="text" placeholder="Search Donor_ID…" />
          <button class="btn secondary" id="exportBtn">Export CSV</button>
        </div>
      </div>

      <div class="kpis" style="margin-bottom:12px">
        <div class="kpi">
          <div class="hint">Total Donors</div>
          <div class="val" id="kTotal">0</div>
        </div>
        <div class="kpi">
          <div class="hint">Eligible ≥ Min P</div>
          <div class="val" id="kReady">0</div>
        </div>
        <div class="kpi">
          <div class="hint">Avg Probability</div>
          <div class="val" id="kAvg">0.00</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:2fr 1fr; gap:12px; margin-bottom:12px">
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th data-col="Rank">Rank ▲▼</th>
                <th data-col="Donor_ID">Donor_ID ▲▼</th>
                <th data-col="Recency">Recency</th>
                <th data-col="Frequency">Frequency</th>
                <th data-col="Monetary">Monetary (cc)</th>
                <th data-col="Time">Time</th>
                <th data-col="Probability">Probability</th>
                <th>Priority</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h2>Readiness Split</h2>
          <canvas id="pie" width="360" height="300"></canvas>
          <div class="hint" style="margin-top:8px">Shows share of donors above vs below threshold.</div>
        </div>
      </div>

      <div class="foot">Data shown is filtered/sorted view. Use Export to save your current table.</div>
    </section>
  </main>

<script>
/* ===== Utilities ===== */
const el = id => document.getElementById(id);
const sigmoid = z => 1/(1+Math.exp(-z));
const fmt = n => Number(n).toFixed(2);
let rawRows = [];      // original parsed rows
let viewRows = [];     // processed + filtered rows
let sortKey = 'Probability', sortAsc = false;

/* ===== CSV Parsing ===== */
function parseCSV(text){
  // very light CSV parser (no quoted commas support)
  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(',').map(h => h.trim());
  return lines.slice(1).map(line=>{
    const cols = line.split(',').map(x=>x.trim());
    const obj = {};
    header.forEach((h,i)=>obj[h]=cols[i]);
    return obj;
  });
}

/* ===== Probability Compute (Option A) ===== */
function computeProbability(row){
  const b = parseFloat(el('wB').value);
  const wR = parseFloat(el('wR').value);
  const wF = parseFloat(el('wF').value);
  const wM = parseFloat(el('wM').value);
  const wT = parseFloat(el('wT').value);
  const Recency = parseFloat(row.Recency||row['Recency (months)']||0);
  const Frequency = parseFloat(row.Frequency||row['Frequency (times)']||0);
  const Monetary = parseFloat(row.Monetary||row['Monetary (c.c. blood)']||0);
  const Time = parseFloat(row.Time||row['Time (months)']||0);
  const z = b + wR*(-Recency) + wF*Frequency + wM*(Monetary/1000) + wT*Time;
  return sigmoid(z);
}

/* ===== Process & Render ===== */
function process(){
  const mode = el('mode').value;
  const minP = parseFloat(el('minProb').value);
  const topN = parseInt(el('topN').value || 25, 10);

  el('chipMin').textContent = minP.toFixed(2);
  el('chipTop').textContent = topN;
  el('chipMode').textContent = mode==='compute' ? 'Compute' : 'Use Provided';

  // map rows to numeric + probability
  let rows = rawRows.map((r,i)=>{
    const Donor_ID = r.Donor_ID || r.id || String(i+1);
    const Recency = Number(r.Recency || r['Recency (months)'] || 0);
    const Frequency = Number(r.Frequency || r['Frequency (times)'] || 0);
    const Monetary = Number(r.Monetary || r['Monetary (c.c. blood)'] || 0);
    const Time = Number(r.Time || r['Time (months)'] || 0);
    const Probability = mode==='compute' ? computeProbability(r) : Number(r.Probability || 0);
    return {Donor_ID, Recency, Frequency, Monetary, Time, Probability};
  });

  // sort by probability desc
  rows.sort((a,b)=>b.Probability - a.Probability);
  // assign rank
  rows.forEach((r,idx)=>r.Rank = idx+1);
  // filter
  rows = rows.filter(r => r.Probability >= minP);
  // search
  const q = el('search').value.trim().toLowerCase();
  if(q) rows = rows.filter(r => String(r.Donor_ID).toLowerCase().includes(q));
  // topN
  rows = rows.slice(0, topN);

  viewRows = rows;
  updateKPIs();
  drawTable();
  drawPie();
}

function priorityBadge(p){
  if(p >= 0.75) return `<span class="badge hi">High</span>`;
  if(p >= 0.55) return `<span class="badge mid">Medium</span>`;
  return `<span class="badge low">Low</span>`;
}

function drawTable(){
  // optional column sorting
  viewRows.sort((a,b)=>{
    let x=a[sortKey], y=b[sortKey];
    if(typeof x==="string"){ x=x.toLowerCase(); y=y.toLowerCase(); }
    return sortAsc ? (x>y?1:x<y?-1:0) : (x<y?1:x>y?-1:0);
  });

  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = viewRows.map(r => `
    <tr>
      <td>${r.Rank}</td>
      <td>${r.Donor_ID}</td>
      <td>${r.Recency}</td>
      <td>${r.Frequency}</td>
      <td>${r.Monetary}</td>
      <td>${r.Time}</td>
      <td>${fmt(r.Probability)}</td>
      <td>${priorityBadge(r.Probability)}</td>
    </tr>
  `).join('');
}

function updateKPIs(){
  const total = rawRows.length;
  const ready = viewRows.length;
  const avg = viewRows.length ? viewRows.reduce((s,r)=>s+r.Probability,0)/viewRows.length : 0;
  el('kTotal').textContent = total;
  el('kReady').textContent = ready;
  el('kAvg').textContent = fmt(avg);
}

/* ===== PIE ===== */
function drawPie(){
  const minP = parseFloat(el('minProb').value);
  const above = viewRows.length;
  const below = Math.max(rawRows.length - above, 0);
  const data = [above, below];
  const colors = ['#29a36a','#2a6bd6'];
  const labels = ['Above threshold','Below threshold'];

  const c = el('pie'); const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const cx = c.width/2, cy = c.height/2, r = Math.min(cx,cy)-10;
  const sum = data.reduce((a,b)=>a+b,0) || 1;
  let start= -Math.PI/2;
  data.forEach((val,i)=>{
    const angle = (val/sum)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+angle); ctx.closePath();
    ctx.fillStyle = colors[i]; ctx.fill();
    // labels
    const mid = start + angle/2;
    const lx = cx + (r*0.6)*Math.cos(mid);
    const ly = cy + (r*0.6)*Math.sin(mid);
    ctx.fillStyle = '#eef7ff';
    ctx.font = 'bold 12px system-ui';
    const pct = ((val/sum)*100).toFixed(0)+'%';
    ctx.fillText(labels[i]+' '+pct, lx-40, ly);
    start += angle;
  });
}

/* ===== Handlers ===== */
el('fileInput').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    rawRows = parseCSV(reader.result);
    process();
  };
  reader.readAsText(f);
});

['mode','wB','wR','wF','wM','wT','minProb','topN','search'].forEach(id=>{
  el(id).addEventListener('input', ()=>{
    el('minProbVal').textContent = Number(el('minProb').value).toFixed(2);
    el('chipMin').textContent = Number(el('minProb').value).toFixed(2);
    el('chipTop').textContent = el('topN').value;
    process();
  });
});

document.querySelectorAll('#tbl th[data-col]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const col = th.getAttribute('data-col');
    if(sortKey===col){ sortAsc=!sortAsc } else { sortKey=col; sortAsc=false; }
    drawTable();
  });
});

el('exportBtn').addEventListener('click', ()=>{
  if(!viewRows.length) return alert('Nothing to export yet.');
  const header = ['Rank','Donor_ID','Recency','Frequency','Monetary','Time','Probability'];
  const lines = [header.join(',')].concat(viewRows.map(r =>
    [r.Rank,r.Donor_ID,r.Recency,r.Frequency,r.Monetary,r.Time,fmt(r.Probability)].join(',')
  ));
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'top_donors.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* ===== Sample Data ===== */
const SAMPLE = `Donor_ID,Recency,Frequency,Monetary,Time
D001,3,12,3000,24
D002,10,4,1000,12
D003,1,20,5000,40
D004,18,2,500,6
D005,5,9,2250,30
D006,2,14,3500,28
D007,30,1,250,2
D008,7,7,1750,20
D009,0,25,6250,60
D010,12,3,750,10`;

el('sample').addEventListener('click', ()=>{
  rawRows = parseCSV(SAMPLE);
  process();
});

/* First paint for empty view */
process();
</script>
</body>
</html>
